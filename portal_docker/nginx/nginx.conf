events {
    # worker_connections  1024;
}

http {
    server_tokens off;
    charset utf-8;

    server {
        listen 80 default_server;
        server_name _;
        return 301 https://$host$request_uri;
	    
        location ~ /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }
    }

    server {
        listen 443 ssl http2;

        include /etc/nginx/mime.types;

        # use the certificates
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_certificate     /etc/letsencrypt/live/c100-099.cloud.gwdg.de/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/c100-099.cloud.gwdg.de/privkey.pem;

        proxy_set_header X-Forwarded-For $proxy_protocol_addr; # To forward the original client's IP address 
        proxy_set_header X-Forwarded-Proto $scheme; # to forward the  original protocol (HTTP or HTTPS)
        proxy_set_header Host $host; # to forward the original host requested by the client

        proxy_ssl_name c100-099.cloud.gwdg.de;
        proxy_ssl_server_name on; #

        # keycloak sends pretty large headers with auth-tokens
        proxy_buffer_size          64k;
        proxy_buffers              4 64k;
        proxy_busy_buffers_size    64k;

        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        add_header Content-Security-Policy "default-src http://192.168.208.5 http://c100-099.cloud.gwdg.de https://c100-099.cloud.gwdg.de 'self'; frame-ancestors https://c100-099.cloud.gwdg.de; script-src https://c100-099.cloud.gwdg.de 'unsafe-inline'; font-src https://fonts.gstatic.com https://c100-099.cloud.gwdg.de;style-src https://c100-099.cloud.gwdg.de https://fonts.googleapis.com 'unsafe-inline'; img-src https://c100-099.cloud.gwdg.de;";   
        # connect-src https://141.5.100.99:8443 https://c100-099.cloud.gwdg.de 'self' connect-src 'self'; 'unsafe-eval'
        #add_header X-Content-Type-Options nosniff;    # cannot apply now because of open keycloak issue https://issues.redhat.com/browse/KEYCLOAK-17076
        #add_header X-XSS-Protection: "1; mode=block";

        server_name c100-099.cloud.gwdg.de;
        root /var/www/html;
        index index.php index.html index.htm;

	    # EHRBase Endpoint
        location /ehrbase {
            proxy_pass http://portal-ehrbase:8080/ehrbase;
        }

        # NUM Portal 
        # Web App (Frontend)
        location / {
            proxy_pass http://num-webapp:80;
        }

        #location /backend {
        #    #default_type application/json;
        #    proxy_pass http://num-portal:8090;
        # rewirte sodass beim weiterleiten das backend rausgenommen wird aka https://$host$request_uri;
        #}

        # NUM Portal (Backend)          /content is used elsewhere so we have to state all subpaths
        location /profile {
            default_type application/json;
            proxy_pass http://num-portal:8090/profile;
        }
        location /content/metrics {
            proxy_pass http://num-portal:8090;
        }
        location /content/graph {
            proxy_pass http://num-portal:8090;
        }
        location /content/navigation {
            default_type application/json;
            proxy_pass http://num-portal:8090;
        }
        location /content/cards {
            default_type application/json;
            proxy_pass http://num-portal:8090;
        }
        location /content/latest-projects {
            default_type application/json;
            proxy_pass http://num-portal:8090;
        }
        location /admin/user {
            proxy_pass http://num-portal:8090/admin/user;
        }
        location /cofoni/financedprojects {
            proxy_pass http://num-portal:8090/cofoni/financedprojects;
        }
        location /aql {
            proxy_pass http://num-portal:8090;
        }
        ## Test
        location /aqls {
            proxy_pass http://num-portal:8090;
        } 
        location /aqls/new/editor {     # or is this directed at the ehrbase?  mioght be
            proxy_pass http://num-portal:8090;
        } 
        location /aqleditor/v1/containment {
            proxy_pass http://num-portal:8090;
        } 
        #nginx              | 2022-10-17T15:03:28.688235301Z 77.21.128.5 - - [17/Oct/2022:15:03:28 +0000] "GET /profile HTTP/2.0" 200 534 "https://c100-099.cloud.gwdg.de/aqls/new/editor" <-- 534 = access without SSL

        #| 2022-10-17T15:42:54.522652239Z 2022-10-17 15:42:54.522 TRACE 1 --- [nio-8090-exec-8] o.s.web.method.HandlerMethod             : Arguments: [org.springframework.web.util.NestedServletException: Handler dispatch failed; nested exception is java.lang.NoClassDefFoundError: org/ehrbase/webtemplate/parser/FlatPath]
        # num-portal_1       | 2022-10-17T15:42:54.523851159Z 2022-10-17 15:42:54.523 ERROR 1 --- [nio-8090-exec-8] d.v.n.w.exception.RestExceptionHandler   : Handler dispatch failed; nested exception is java.lang.NoClassDefFoundError: org/ehrbase/webtemplate/parser/FlatPath

        #  org.springframework.web.util.NestedServletException: Handler dispatch failed; nested exception is java.lang.NoClassDefFoundError: org/ehrbase/webtemplate/parser/FlatPath
        ## -- Test
        location /aql/size {
            proxy_pass http://num-portal:8090/aql/size;
        }
        location /aql/category {
            proxy_pass http://num-portal:8090/aql/category;
        }
        location /aqleditor {
            proxy_pass http://num-portal:8090/aqleditor;
        }
        location /organization {
            proxy_pass http://num-portal:8090/organization;
        }
        location /project {
            proxy_pass http://num-portal:8090/project;
        }
        location ~ /min-maps/vs {
            proxy_pass http://num-portal:8090;
        }

        # KeyCloak (Auth-Server)
        location /auth {
            proxy_pass https://portal-keycloak:8443;
        }

	    # Location of SSL-Stuff
        location ~ /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }
    }
}
